---
title: "exploration"
header-includes: |
  \makeatletter
  \def\verbatim@nolig@list{}
  \makeatother
  \usepackage{cancel}
  \usepackage[fontsize=9.5pt]{scrextend}
output:
  html_document:
    df_print: paged
  pdf_document:
    highlight: default
    latex_engine: xelatex
    number_sections: yes
classoption: landscape
monofont: Fira Code Retina
geometry: margin=0.5in
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
set.seed(42)
```

```{r}
# Each experiment has a tsv output; bind them together into one table
prefix <- 'lm1b_'
n_forms <- 1
n_tuples <- 25

for (i in 1:n_forms) {
  input <- read.csv(paste(prefix, i, '.tsv', sep=''), sep='\t') %>%
    mutate(experiment=i)
  # TODO switch T/F strings to booleans
  if (i == 1) tbl <- tbl_df(input)
  else tbl <- bind_rows(tbl, input)
}
# Just a taste...
sample_n(tbl, 10)
```

Our big ol' question: does entailment affect surprisal?
```{r}
ggplot(tbl, aes(x=correct, y=inference, color=interaction(correct, experiment))) +
  facet_wrap(~ experiment) +
  # geom_point(alpha = 0.2, position = "jitter") + 
  geom_boxplot(alpha=0, color='black', notch=T) +
  theme(legend.position="none") +
  scale_y_continuous(limits=c(67.9, 68))
  xlab("Entailment, Contradiction in all Experiments")
ggsave("entailment_all_boxplot_scatter.pdf", width=8, dpi="retina")
```

How do crossing dependencies play into this? In particular, do crossing dependencies affect surprisal?
```{r}
ggplot(tbl, aes(x=Crossing, y=Surprisal, color=interaction(Crossing))) +
  facet_wrap(~ Experiment) +
  geom_point(alpha = 0.2, position = "jitter") + 
  geom_boxplot(alpha=0, color='black', notch=T) +
  theme(legend.position="none") +
  xlab("Crossing, Not Crossing Implications in all Experiments")
ggsave("crossing_all_boxplot_scatter.pdf", width=8, height=3.5, dpi="retina")

# Compare Experiment 2, 6.
tbl %>% subset(Experiment %in% c(2, 6)) %>%
  ggplot(aes(x=Entailment, y=Surprisal, color=interaction(Crossing))) +
    facet_wrap(~ Experiment) +
    geom_point(alpha = 0.2, position = "jitter") + 
    geom_boxplot(alpha=0, color='black', notch=T) +
    xlab("Entailment, Contradiction in Experiments 2, 6")
ggsave("crossing_on_entailment_26_boxplot_scatter.pdf", dpi="retina")

# Compare Experiment 4, 5.
tbl %>% subset(Experiment %in% c(4, 5)) %>%
  ggplot(aes(x=Entailment, y=Surprisal, color=interaction(Crossing))) +
    facet_wrap(~ Experiment) +
    geom_point(alpha = 0.2, position = "jitter") + 
    geom_boxplot(alpha=0, color='black', notch=T) +
    xlab("Entailment, Contradiction in Experiments 4, 5")
ggsave("crossing_on_entailment_45_boxplot_scatter.pdf", dpi="retina")
```


* In Exp2, all the Xing entailments involve Vin, while all the non-Xing entailments involve Vtr.
* In Exp6, all the Xing entailments involve Vin, while all the non-Xing entailments involve Xtr.

* Exp1 is all non-crossing; entailments are intransitive
* Exp3 is all non-crossing; entailments are intransitive
* Exp4 is all crossing; entailments are transitive
* Exp5 is all non-crossing; entailments are transitive
* Exp7 is all crossing; entailments are transitive and intransitive.

```{r}
# Overall?
ggplot(tbl, aes(x=Crossing, y=Surprisal, fill=Crossing)) +
    #geom_point(alpha = 0.2, position = "jitter") + 
    geom_boxplot(notch=T) +
    theme(legend.position="none") +
    xlab("Crossing, Not Crossing in all Experiments")
ggsave("crossing_all_boxplot.pdf", dpi="retina")
```

Is there interaction with Preposition? Experiment 3.
```{r}
tbl %>% subset(Experiment %in% c(3)) %>%
  ggplot(aes(x=Entailment, y=Surprisal, color=interaction(Preposition))) +
    geom_point(alpha = 0.2, position = "jitter") + 
    geom_boxplot(alpha=0, color='black', notch=T) +
    xlab("Prepositions in Experiment 3")
ggsave("preps_3_boxplot_scatter.pdf", dpi="retina")
```

Is there interaction with Expletive/Demonstrative? Experiments 4, 5.
```{r}
tbl %>% subset(Experiment %in% c(4, 5)) %>%
  ggplot(aes(x=Entailment, y=Surprisal, color=interaction(E.D))) +
    geom_point(alpha = 0.2, position = "jitter") + 
    geom_boxplot(alpha=0, color='black', notch=T) +
    xlab("Expletive/Demonstratives in Experiments 4, 6")
ggsave("ED_46_boxplot_scatter.pdf", dpi="retina")
```

Is there interaction with Connective?
```{r}
ggplot(tbl, aes(x=correct, y=inference, color=interaction(X.Conn.))) +
  geom_point(alpha = 0.2, position = "jitter") + 
  geom_boxplot(alpha=0, color='black', notch=T) +
  xlab("Connectives in all Experiments")
ggsave("connectives_all_boxplot_scatter.pdf")
ggplot(tbl, aes(x=correct, y=inference, fill=correct)) +
  facet_wrap(~ X.Conn.) +
  theme(legend.position="none") +
  geom_boxplot(notch=T) +
  xlab("Entailment, not Entailment for each Connective")
ggsave("connectives_each_boxplots.pdf", dpi="retina")
```

Time for tea! T-tests. Considering the difference of means (of surprisal) for not-entailment versus entailment across each experiment, if the network makes the right inferences about these entailments, then we'd expect $\mu_{\text{not entailment}}-\mu_{\text{entailment}}$ to be positive.

```{r}
tests <- vector('list', n_forms)

for (i in 1:n_forms) {
  S_not <- filter(tbl, (experiment==i & correct=='False'))$inference
  S_ent <- filter(tbl, (experiment==i & correct=='True'))$inference
  test <- t.test(S_not, S_ent, paired=T)
  tests[[i]] <- test
}
tests
```

```{r}
estimators <- tbl_df(t(sapply(tests, c))) %>% # https://stackoverflow.com/questions/4227223/convert-a-list-to-a-data-frame
  select(c('stderr', 'estimate')) %>%
  transmute(diff_means=as.numeric(estimate), stderr=as.numeric(stderr)) %>%
  mutate(experiment=1:n_forms)

ggplot(estimators, aes(x=experiment, y=diff_means, fill=experiment)) +
  geom_bar(stat="identity", position="dodge") +
  theme(legend.position="none") +
  geom_errorbar(aes(ymin=(diff_means - 1.96 * stderr), ymax=(diff_means + 1.96 * stderr)), color='black', width=.3) +
  scale_x_continuous(breaks=1:n_forms) +
  xlab("Mean S(Contradiction)-S(Entailment), per-Experiment")
ggsave("diff_means_barplot_errors.pdf", dpi="retina")
```